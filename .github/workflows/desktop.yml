# .github/workflows/crd-ubuntu.yml
name: Ubuntu with Lubuntu Desktop + CRD

on:
  workflow_dispatch:
    inputs:
      crd_auth_command:
        description: 'Paste CRD auth command (copied from https://remotedesktop.google.com/headless)'
        required: true
        type: string

jobs:
  setup-vps:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6 ti·∫øng
    steps:
      - name: Update APT
        run: |
          sudo apt update

      - name: Install Lubuntu Desktop Environment (LXQt)
        run: |
          sudo apt install -y \
            lxqt-core \
            lxqt-session \
            openbox \
            xorg \
            dbus-x11 \
            lightdm \
            fonts-font-awesome \
            terminator \
            unzip \
            wget

      - name: Install Chrome Remote Desktop
        run: |
          wget https://dl.google.com/linux/direct/chrome-remote-desktop_current_amd64.deb
          sudo dpkg -i chrome-remote-desktop_current_amd64.deb || sudo apt-get -f install -y

      - name: Set LXQt session for CRD
        run: |
          echo "exec startlxqt" > ~/.chrome-remote-desktop-session

      - name: Enable CRD using auth command with auto PIN
        run: |
          echo "${{ github.event.inputs.crd_auth_command }} --pin=123456" > crd.sh
          chmod +x crd.sh
          ./crd.sh

      - name: Start Keep-Alive Ping
        run: |
          echo "üîÅ Starting keep-alive loop to prevent idle disconnect..."
          nohup bash -c 'while true; do echo "üü¢ CRD Keep Alive Ping: $(date)"; sleep 300; done' > keepalive.log 2>&1 &

      - name: Print Info
        run: |
          echo "‚úÖ CRD is now running with Lubuntu Desktop and default PIN 123456."
          echo "‚è≥ Keep-alive task is running every 5 minutes to prevent timeout."
